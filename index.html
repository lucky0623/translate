<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç¿»è­¯ç³»çµ± - Vercel ç‰ˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #e0e7ff;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --btn-primary: #2563eb;
            --btn-primary-hover: #1d4ed8;
            --output-bg: #f9fafb;
            --purple-border: #c4b5fd;
            --purple-bg: #faf5ff;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --btn-primary: #3b82f6;
            --btn-primary-hover: #2563eb;
            --output-bg: #0f172a;
            --purple-border: #7c3aed;
            --purple-bg: #1e1b4b;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: linear-gradient(to bottom right, var(--bg-primary), var(--bg-secondary)); 
            min-height: 100vh; 
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        h1 { font-size: 32px; color: var(--text-primary); }
        
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .theme-toggle { 
            background: var(--bg-card); 
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }
        .theme-toggle:hover { transform: scale(1.1); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--btn-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--btn-primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; transform: translateY(-2px); }
        .btn-indigo { background: #6366f1; color: white; }
        .btn-indigo:hover { background: #4f46e5; transform: translateY(-2px); }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            padding: 24px; 
            margin-bottom: 24px;
            transition: background 0.3s;
        }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: 1fr; }
            h1 { font-size: 24px; }
        }
        
        textarea { 
            width: 100%; 
            height: 250px; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            resize: vertical; 
            font-size: 14px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--btn-primary); }
        
        .output { 
            width: 100%; 
            min-height: 250px; 
            padding: 12px; 
            background: var(--output-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
            font-size: 14px;
            line-height: 1.6;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background: var(--bg-secondary); font-weight: 600; }
        tr:hover { background: var(--output-bg); }
        
        .checkbox-cell { width: 50px; text-align: center; }
        .vocab-checkbox { 
            width: 18px; 
            height: 18px; 
            cursor: pointer;
            accent-color: var(--btn-primary);
        }
        
        .settings-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .settings-content { 
            background: var(--bg-card); 
            border-radius: 12px; 
            padding: 32px; 
            max-width: 500px; 
            width: 90%;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            margin: 8px 0;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .input:focus { outline: none; border-color: var(--btn-primary); }
        
        .spinner { 
            border: 3px solid var(--border-color); 
            border-top: 3px solid var(--btn-primary); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 100px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .purple-card { border: 2px solid var(--purple-border); }
        .purple-output { background: var(--purple-bg); }
        
        .error-message { 
            color: #ef4444; 
            padding: 12px; 
            background: #fee2e2; 
            border-radius: 8px; 
            margin-top: 12px;
        }
        
        [data-theme="dark"] .error-message {
            background: #7f1d1d;
            color: #fca5a5;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-success { background: #d1fae5; color: #065f46; }
        .status-loading { background: #dbeafe; color: #1e40af; }
        
        [data-theme="dark"] .status-success { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .status-loading { background: #1e3a8a; color: #93c5fd; }
        
        .selection-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #1e40af;
        }
        
        [data-theme="dark"] .selection-hint {
            background: #1e3a8a;
            border-color: #3b82f6;
            color: #93c5fd;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUpAnim {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .vocab-settings-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 24px;
            border: none;
            animation: slideDown 0.3s ease-out;
        }
        
        .vocab-settings-panel h2,
        .vocab-settings-panel p,
        .vocab-settings-panel label {
            color: white;
        }
        
        .vocab-settings-panel select {
            background: white;
            color: #1f2937;
        }
        
        .vocab-settings-panel .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .vocab-settings-panel .btn-primary:hover {
            background: #f3f4f6;
            color: #4f46e5;
        }
        
        .vocab-settings-panel button[title="é—œé–‰"]:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        [data-theme="dark"] .vocab-settings-panel {
            background: linear-gradient(135deg, #4c1d95 0%, #581c87 100%);
        }
        
        [data-theme="dark"] .vocab-settings-panel select {
            background: #1e293b;
            color: #f1f5f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ æ™ºèƒ½ç¿»è­¯ç³»çµ±</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">ğŸŒ“</button>
                <button class="btn btn-secondary" onclick="showSettings()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="translate()" id="translateBtn">é–‹å§‹ç¿»è­¯</button>
            <button class="btn btn-indigo" onclick="showVocabSettings()" id="vocabBtn">ğŸ“š è£½ä½œå–®å­—è¡¨</button>
        </div>

        <div id="vocabSettingsPanel" class="card vocab-settings-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; font-size: 20px;">ğŸ“š å–®å­—è¡¨è¨­å®š</h2>
                <button onclick="closeVocabSettings()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 4px 8px; line-height: 1;" title="é—œé–‰">âœ•</button>
            </div>
            <p style="margin-bottom: 16px; opacity: 0.95;">é¸æ“‡ç¿»è­¯ç›®æ¨™èªè¨€</p>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ç¿»è­¯èªè¨€ï¼š</label>
                <select class="input" id="targetLang">
                    <option value="ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰">ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰</option>
                    <option value="è‹±æ–‡">è‹±æ–‡</option>
                    <option value="æ—¥æ–‡">æ—¥æ–‡</option>
                    <option value="éŸ“æ–‡">éŸ“æ–‡</option>
                    <option value="æ³•æ–‡">æ³•æ–‡</option>
                    <option value="å¾·æ–‡">å¾·æ–‡</option>
                    <option value="è¥¿ç­ç‰™æ–‡">è¥¿ç­ç‰™æ–‡</option>
                    <option value="ç¾©å¤§åˆ©æ–‡">ç¾©å¤§åˆ©æ–‡</option>
                    <option value="è‘¡è„ç‰™æ–‡">è‘¡è„ç‰™æ–‡</option>
                    <option value="ä¿„æ–‡">ä¿„æ–‡</option>
                    <option value="é˜¿æ‹‰ä¼¯æ–‡">é˜¿æ‹‰ä¼¯æ–‡</option>
                    <option value="æ³°æ–‡">æ³°æ–‡</option>
                    <option value="è¶Šå—æ–‡">è¶Šå—æ–‡</option>
                    <option value="å°å°¼æ–‡">å°å°¼æ–‡</option>
                </select>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="generateVocabWithSettings()">é–‹å§‹è£½ä½œ</button>
                <button class="btn btn-secondary" onclick="closeVocabSettings()">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="grid-3">
            <div class="card">
                <h2 style="margin-bottom: 12px; font-size: 18px;">åŸæ–‡</h2>
                <textarea id="sourceText" placeholder="è¼¸å…¥ä»»ä½•èªè¨€çš„æ–‡å­—..."></textarea>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 12px; font-size: 18px;">
                    åˆæ­¥è­¯æ–‡ 
                    <span style="font-size: 12px; color: var(--text-secondary);">(Sonnet 4)</span>
                    <span id="translateStatus1"></span>
                </h2>
                <div class="output" id="targetText">ç¿»è­¯çµæœå°‡é¡¯ç¤ºåœ¨æ­¤...</div>
            </div>

            <div class="card purple-card">
                <h2 style="margin-bottom: 12px; font-size: 18px;">
                    æ½¤ç¨¿çµæœ 
                    <span style="font-size: 12px; color: #7c3aed;">(Opus 4)</span>
                    <span id="translateStatus2"></span>
                </h2>
                <div class="output purple-output" id="polishedText">æ½¤ç¨¿çµæœå°‡é¡¯ç¤ºåœ¨æ­¤...</div>
            </div>
        </div>

        <div id="vocabSection" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <h2 style="font-size: 20px;">å–®å­—è¡¨ <span id="vocabCount"></span></h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="selectAll()" id="selectAllBtn" style="display: none;">âœ“ å…¨é¸</button>
                        <button class="btn btn-secondary" onclick="deselectAll()" id="deselectAllBtn" style="display: none;">âœ— å…¨ä¸é¸</button>
                        <button class="btn btn-indigo" onclick="confirmSelection()" id="confirmBtn" style="display: none;">ç¢ºèªä¿ç•™å‹¾é¸é …ç›®</button>
                        <button class="btn btn-success" onclick="downloadCSV()">ğŸ“Š ä¸‹è¼‰ CSV</button>
                        <button class="btn btn-primary" onclick="downloadMarkdown()">ğŸ“ ä¸‹è¼‰ Markdown</button>
                    </div>
                </div>
                <div id="vocabTable"></div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 14px;">
            <p>âœ¨ Vercel ç‰ˆæœ¬ â€¢ ä½¿ç”¨æ‚¨è‡ªå·±çš„ API Key â€¢ æ‰€æœ‰è³‡æ–™åƒ…åœ¨æœ¬æ©Ÿè™•ç†</p>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal" style="display: none;">
        <div class="settings-content">
            <h2 style="margin-bottom: 16px; font-size: 24px;">ğŸ”‘ API Key è¨­å®š</h2>
            <p style="margin-bottom: 12px; color: var(--text-secondary);">è«‹è¼¸å…¥æ‚¨çš„ Anthropic API Key</p>
            <p style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary);">
                å–å¾—æ–¹å¼ï¼š<br>
                1. å‰å¾€ <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: var(--btn-primary);">Anthropic Console</a><br>
                2. å»ºç«‹æ–°çš„ API Key<br>
                3. è¤‡è£½é‡‘é‘°ï¼ˆæ ¼å¼ï¼šsk-ant-xxxxxï¼‰
            </p>
            <input type="password" class="input" id="apiKeyInput" placeholder="sk-ant-xxxxx...">
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="saveApiKey()">å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨</button>
                <button class="btn btn-secondary" onclick="closeSettings()">å–æ¶ˆ</button>
            </div>
            <p style="margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                ğŸ’¡ API Key åƒ…å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œé€éæ‚¨çš„ Vercel ä¼ºæœå™¨å‚³é
            </p>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('anthropic_api_key') || '';
        let vocabularyList = [];
        let targetLanguage = 'ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰';
        let detectedSourceLanguage = 'åŸæ–‡';

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        if (!apiKey) {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function showSettings() {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            if (apiKey) {
                document.getElementById('settingsModal').style.display = 'none';
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input && input.startsWith('sk-ant-')) {
                apiKey = input;
                localStorage.setItem('anthropic_api_key', apiKey);
                document.getElementById('settingsModal').style.display = 'none';
                alert('âœ… API Key å·²å„²å­˜ï¼');
            } else {
                alert('âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Keyï¼ˆæ ¼å¼ï¼šsk-ant-xxxxxï¼‰');
            }
        }

        function showVocabSettings() {
            if (!apiKey) {
                alert('è«‹å…ˆè¨­å®š API Key');
                showSettings();
                return;
            }

            const sourceText = document.getElementById('sourceText').value.trim();
            if (!sourceText) {
                alert('è«‹å…ˆè¼¸å…¥æ–‡å­—');
                return;
            }

            document.getElementById('vocabSettingsPanel').style.display = 'block';
            document.getElementById('vocabSettingsPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function closeVocabSettings() {
            const panel = document.getElementById('vocabSettingsPanel');
            panel.style.animation = 'slideUpAnim 0.3s ease-out';
            setTimeout(() => {
                panel.style.display = 'none';
                panel.style.animation = '';
            }, 300);
        }

        async function callClaude(prompt, model = 'claude-sonnet-4-20250514', retries = 2) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch('/api/claude', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            model: model,
                            apiKey: apiKey
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `API éŒ¯èª¤: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.content[0].text;
                } catch (error) {
                    console.error('API å‘¼å«éŒ¯èª¤:', error);
                    if (i === retries) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        async function translate() {
            if (!apiKey) {
                alert('è«‹å…ˆè¨­å®š API Key');
                showSettings();
                return;
            }

            const sourceText = document.getElementById('sourceText').value.trim();
            if (!sourceText) {
                alert('è«‹å…ˆè¼¸å…¥æ–‡å­—');
                return;
            }

            document.getElementById('translateBtn').disabled = true;
            document.getElementById('vocabBtn').disabled = true;
            document.getElementById('targetText').innerHTML = '<div class="spinner"></div>';
            document.getElementById('polishedText').innerHTML = '<div class="spinner"></div>';
            document.getElementById('translateStatus1').innerHTML = '<span class="status-indicator status-loading">ç¿»è­¯ä¸­...</span>';
            document.getElementById('translateStatus2').innerHTML = '<span class="status-indicator status-loading">ç­‰å¾…ä¸­...</span>';

            try {
                const translationPrompt = `ä½ æ˜¯å°ˆæ¥­çš„ç¿»è­¯å°ˆå®¶ã€‚è«‹å°‡ä»¥ä¸‹æ–‡å­—ç¿»è­¯æˆç¹é«”ä¸­æ–‡ï¼ˆå°ç£ç”¨èªï¼‰ã€‚

è¦æ±‚ï¼š
- ä¿æŒåŸæ–‡çš„èªæ°£å’Œé¢¨æ ¼
- ä½¿ç”¨å°ç£æ…£ç”¨çš„è©å½™å’Œè¡¨é”æ–¹å¼
- ç¢ºä¿ç¿»è­¯æµæš¢è‡ªç„¶
- åªè¼¸å‡ºç¿»è­¯çµæœï¼Œä¸è¦æ·»åŠ ä»»ä½•èªªæ˜æˆ–è¨»è§£

åŸæ–‡ï¼š
${sourceText}`;

                const translation = await callClaude(translationPrompt);
                document.getElementById('targetText').textContent = translation;
                document.getElementById('translateStatus1').innerHTML = '<span class="status-indicator status-success">å®Œæˆ</span>';
                document.getElementById('translateStatus2').innerHTML = '<span class="status-indicator status-loading">æ½¤ç¨¿ä¸­...</span>';

                const polishPrompt = `ä½ æ˜¯è³‡æ·±çš„ç¿»è­¯å¯©æ ¡å°ˆå®¶ã€‚è«‹å¯©æ ¸ä¸¦å„ªåŒ–ä»¥ä¸‹ç¿»è­¯ã€‚

ä»»å‹™ï¼š
1. æª¢æŸ¥ç¿»è­¯æº–ç¢ºæ€§ï¼Œç¢ºä¿å¿ æ–¼åŸæ–‡
2. æ”¹å–„èªå¥æµæš¢åº¦å’Œè‡ªç„¶åº¦
3. å„ªåŒ–ç”¨è©ï¼Œä½¿å…¶æ›´ç¬¦åˆå°ç£ç”¨èªç¿’æ…£
4. ç¢ºä¿æ•´é«”é–±è®€é«”é©—è‰¯å¥½
5. åªè¼¸å‡ºæœ€çµ‚çš„æ½¤ç¨¿çµæœï¼Œä¸è¦å…¶ä»–å…§å®¹

åŸæ–‡ï¼š
${sourceText}

åˆæ­¥è­¯æ–‡ï¼š
${translation}

è«‹æä¾›æ½¤ç¨¿å¾Œçš„æœ€çµ‚ç‰ˆæœ¬ï¼š`;

                const polished = await callClaude(polishPrompt, 'claude-opus-4-20250514');
                document.getElementById('polishedText').textContent = polished;
                document.getElementById('translateStatus2').innerHTML = '<span class="status-indicator status-success">å®Œæˆ</span>';

                alert('âœ… ç¿»è­¯å®Œæˆï¼');
            } catch (error) {
                console.error('ç¿»è­¯éŒ¯èª¤:', error);
                const errorMsg = `ç¿»è­¯å¤±æ•—ï¼š${error.message}`;
                document.getElementById('targetText').innerHTML = `<div class="error-message">${errorMsg}</div>`;
                document.getElementById('polishedText').innerHTML = `<div class="error-message">${errorMsg}</div>`;
                document.getElementById('translateStatus1').textContent = '';
                document.getElementById('translateStatus2').textContent = '';
                alert('âŒ ' + errorMsg);
            } finally {
                document.getElementById('translateBtn').disabled = false;
                document.getElementById('vocabBtn').disabled = false;
            }
        }

        async function generateVocabWithSettings() {
            targetLanguage = document.getElementById('targetLang').value;
            
            const panel = document.getElementById('vocabSettingsPanel');
            panel.style.animation = 'slideUpAnim 0.3s ease-out';
            setTimeout(() => {
                panel.style.display = 'none';
                panel.style.animation = '';
            }, 300);
            
            await generateVocab();
        }

        async function generateVocab() {
            const sourceText = document.getElementById('sourceText').value.trim();

            document.getElementById('translateBtn').disabled = true;
            document.getElementById('vocabBtn').disabled = true;
            document.getElementById('vocabSection').style.display = 'block';
            document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div>';

            try {
                const detectPrompt = `è«‹åµæ¸¬ä»¥ä¸‹æ–‡å­—çš„èªè¨€ï¼Œåªå›ç­”èªè¨€åç¨±ï¼ˆä¾‹å¦‚ï¼šè‹±æ–‡ã€æ—¥æ–‡ã€ç¹é«”ä¸­æ–‡ã€éŸ“æ–‡ã€æ³•æ–‡ç­‰ï¼‰ï¼Œä¸è¦å…¶ä»–å…§å®¹ï¼š

${sourceText.substring(0, 200)}`;
                
                detectedSourceLanguage = (await callClaude(detectPrompt)).trim();
                
                const textLength = sourceText.length;
                let allVocabulary = [];
                
                if (textLength <= 500) {
                    document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">æ­£åœ¨æå–è©å½™...</p>';
                    
                    allVocabulary = await extractVocabFromSegment(sourceText, 20);
                } else {
                    const segments = splitTextIntoSegments(sourceText, 500);
                    document.getElementById('vocabTable').innerHTML = `<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">æ–‡ç« è¼ƒé•·ï¼Œæ­£åœ¨åˆ†æ®µè™•ç†... (å…± ${segments.length} æ®µ)</p>`;
                    
                    for (let i = 0; i < segments.length; i++) {
                        document.getElementById('vocabTable').innerHTML = `<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">è™•ç†ç¬¬ ${i + 1}/${segments.length} æ®µ...</p>`;
                        
                        const segmentVocab = await extractVocabFromSegment(segments[i], 15);
                        allVocabulary = allVocabulary.concat(segmentVocab);
                    }
                    
                    document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">æ­£åœ¨åˆä½µä¸¦å»é‡...</p>';
                    allVocabulary = removeDuplicates(allVocabulary);
                    
                    if (allVocabulary.length > 50) {
                        document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">æ­£åœ¨ç¯©é¸æœ€é‡è¦çš„è©å½™...</p>';
                        allVocabulary = await rankAndSelectVocabulary(allVocabulary, sourceText);
                    }
                }
                
                vocabularyList = allVocabulary;
                document.getElementById('vocabCount').textContent = `(${vocabularyList.length} å€‹è©å½™)`;
                
                renderVocabTable(true);
                
                document.getElementById('selectAllBtn').style.display = 'inline-block';
                document.getElementById('deselectAllBtn').style.display = 'inline-block';
                document.getElementById('confirmBtn').style.display = 'inline-block';

                setTimeout(() => {
                    document.getElementById('vocabSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

                alert('âœ… å–®å­—è¡¨ç”¢ç”Ÿå®Œæˆï¼è«‹å‹¾é¸æ‚¨æƒ³ä¿ç•™çš„å–®å­—ã€‚');
            } catch (error) {
                console.error('å–®å­—è¡¨ç”¢ç”ŸéŒ¯èª¤:', error);
                const errorMsg = `ç”¢ç”Ÿå¤±æ•—ï¼š${error.message}`;
                document.getElementById('vocabTable').innerHTML = `<div class="error-message">${errorMsg}</div>`;
                alert('âŒ ' + errorMsg);
            } finally {
                document.getElementById('translateBtn').disabled = false;
                document.getElementById('vocabBtn').disabled = false;
            }
        }

        function splitTextIntoSegments(text, maxLength) {
            const segments = [];
            let currentPos = 0;
            
            while (currentPos < text.length) {
                let endPos = currentPos + maxLength;
                
                if (endPos < text.length) {
                    const searchText = text.substring(currentPos, endPos + 100);
                    const sentenceEnds = [
                        searchText.indexOf('ã€‚'),
                        searchText.indexOf('ï¼Ÿ'),
                        searchText.indexOf('ï¼'),
                        searchText.indexOf('. '),
                        searchText.indexOf('? '),
                        searchText.indexOf('! '),
                        searchText.indexOf('\n\n')
                    ].filter(pos => pos > maxLength * 0.7 && pos !== -1);
                    
                    if (sentenceEnds.length > 0) {
                        endPos = currentPos + Math.min(...sentenceEnds) + 1;
                    }
                }
                
                segments.push(text.substring(currentPos, endPos).trim());
                currentPos = endPos;
            }
            
            return segments;
        }

        async function extractVocabFromSegment(text, count) {
            const vocabPrompt = `ä½ æ˜¯å°ˆæ¥­çš„èªè¨€æ•™å­¸å°ˆå®¶ã€‚è«‹å¾ä»¥ä¸‹æ–‡å­—ç‰‡æ®µä¸­æå– ${count} å€‹æœ€é‡è¦çš„å­¸ç¿’è©å½™ã€‚

ã€æå–æ¨™æº–ã€‘
âœ… å¿…é ˆæå–ï¼š
- é‡è¦çš„å°ˆæ¥­è¡“èªå’Œæ ¸å¿ƒæ¦‚å¿µè©å½™
- é—œéµå‹•è©ã€åè©ã€å½¢å®¹è©
- å›ºæœ‰åè©å’Œå°ˆæœ‰åè©
- æ…£ç”¨èªå’Œé‡è¦è¡¨é”

âŒ ä¸è¦æå–ï¼š
- åŸºç¤å‰¯è©ï¼ˆå¦‚ï¼šå¾ˆã€éå¸¸ï¼‰
- éæ–¼ç°¡å–®çš„æ—¥å¸¸ç”¨èª
- é€£æ¥è©å’ŒåŠ©è©

æ–‡å­—ç‰‡æ®µï¼š
${text}

ã€ç¿»è­¯è¦æ±‚ã€‘
å°æ¯å€‹è©å½™ç¿»è­¯æˆ${targetLanguage}æ™‚ï¼š
- å¦‚æœæœ‰å¤šç¨®åˆé©çš„ç¿»è­¯æ–¹å¼ï¼ˆä¾‹å¦‚ï¼šä¸åŒèªå¢ƒã€æ­£å¼/éæ­£å¼ã€æ–‡è¨€/ç™½è©±ç­‰ï¼‰ï¼Œè«‹æä¾› 2-3 å€‹ç¿»è­¯é¸é …
- å¦‚æœåªæœ‰ä¸€ç¨®æœ€ä½³ç¿»è­¯ï¼Œå°±åªæä¾›ä¸€ç¨®
- å¦‚æœä¸é©åˆç¿»è­¯ï¼ˆä¾‹å¦‚ï¼šå°ˆæœ‰åè©ã€äººåã€åœ°åã€å“ç‰Œåç­‰ï¼‰ï¼Œè«‹åœ¨ translation å¡«å…¥åŸæ–‡ï¼Œä¸¦åœ¨å‚™è¨»èªªæ˜ã€Œä¸éœ€ç¿»è­¯ã€çš„åŸå› 

è«‹åš´æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼å›æ‡‰ï¼Œä¸è¦åŒ…å«ä»»ä½• markdown æ¨™è¨˜ï¼š
{
  "vocabulary": [
    {
      "original": "åŸæ–‡è©å½™",
      "translation": "ç¿»è­¯1 / ç¿»è­¯2 / ç¿»è­¯3",
      "note": "[è©æ€§] èªªæ˜å·®ç•°æˆ–ä¸ç¿»è­¯åŸå› "
    }
  ]
}`;

            const result = await callClaude(vocabPrompt, 'claude-opus-4-20250514');
            const cleanResult = result.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            return JSON.parse(cleanResult).vocabulary;
        }

        function removeDuplicates(vocabulary) {
            const seen = new Map();
            
            vocabulary.forEach(item => {
                const key = item.original.toLowerCase().trim();
                if (!seen.has(key)) {
                    seen.set(key, item);
                } else {
                    const existing = seen.get(key);
                    const existingTranslations = existing.translation.split(' / ');
                    const newTranslations = item.translation.split(' / ');
                    
                    newTranslations.forEach(trans => {
                        if (!existingTranslations.includes(trans)) {
                            existingTranslations.push(trans);
                        }
                    });
                    
                    existing.translation = existingTranslations.join(' / ');
                }
            });
            
            return Array.from(seen.values());
        }

        async function rankAndSelectVocabulary(vocabulary, fullText) {
            const rankPrompt = `ä½ æ˜¯å°ˆæ¥­çš„èªè¨€æ•™å­¸å°ˆå®¶ã€‚ä»¥ä¸‹æ˜¯å¾ä¸€ç¯‡æ–‡ç« ä¸­æå–çš„è©å½™åˆ—è¡¨ï¼Œä½†æ•¸é‡éå¤šã€‚è«‹å¹«æˆ‘ç¯©é¸å‡ºæœ€é‡è¦çš„ 50 å€‹è©å½™ã€‚

ç¯©é¸æ¨™æº–ï¼š
1. èˆ‡æ–‡ç« ä¸»é¡Œæœ€ç›¸é—œçš„æ ¸å¿ƒè©å½™
2. å­¸ç¿’åƒ¹å€¼é«˜çš„è©å½™
3. å‡ºç¾é »ç‡è¼ƒé«˜æˆ–åœ¨é—œéµä½ç½®çš„è©å½™
4. å°ˆæ¥­è¡“èªå„ªå…ˆæ–¼ä¸€èˆ¬è©å½™

åŸæ–‡ç« ä¸»é¡Œæ¦‚è¦ï¼š
${fullText.substring(0, 500)}...

è©å½™åˆ—è¡¨ï¼ˆJSON æ ¼å¼ï¼‰ï¼š
${JSON.stringify(vocabulary, null, 2)}

è«‹å¾ä»¥ä¸Šè©å½™ä¸­é¸å‡ºæœ€é‡è¦çš„ 50 å€‹ï¼Œä¿æŒåŸæœ‰çš„ JSON æ ¼å¼å’Œå…§å®¹ï¼Œåªéœ€è¦è¼¸å‡ºç¯©é¸å¾Œçš„çµæœï¼š
{
  "vocabulary": [...]
}`;

            const result = await callClaude(rankPrompt, 'claude-opus-4-20250514');
            const cleanResult = result.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            return JSON.parse(cleanResult).vocabulary;
        }

        function renderVocabTable(withCheckbox = false) {
            let html = '';
            
            if (withCheckbox) {
                html += `<div class="selection-hint">
                    ğŸ’¡ <strong>æç¤ºï¼š</strong>è«‹å‹¾é¸æ‚¨æƒ³è¦ä¿ç•™çš„å–®å­—ï¼Œå–æ¶ˆå‹¾é¸ä¸éœ€è¦çš„å–®å­—ï¼Œç„¶å¾Œé»é¸ã€Œç¢ºèªä¿ç•™å‹¾é¸é …ç›®ã€
                </div>`;
            }
            
            html += `<div style="overflow-x: auto;"><table>
                <thead>
                    <tr>`;
            
            if (withCheckbox) {
                html += `<th class="checkbox-cell">
                    <input type="checkbox" class="vocab-checkbox" onchange="toggleAllCheckboxes(this)" checked title="å…¨é¸/å–æ¶ˆå…¨é¸">
                </th>`;
            }
            
            html += `<th>${detectedSourceLanguage}</th>
                    <th>${targetLanguage}</th>
                    <th>å‚™è¨»</th>
                </tr>
            </thead>
            <tbody>`;
            
            vocabularyList.forEach((item, index) => {
                html += `<tr>`;
                
                if (withCheckbox) {
                    html += `<td class="checkbox-cell">
                        <input type="checkbox" class="vocab-checkbox vocab-item-checkbox" data-index="${index}" checked>
                    </td>`;
                }
                
                html += `<td>${item.original}</td>
                    <td>${item.translation}</td>
                    <td>${item.note}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('vocabTable').innerHTML = html;
        }

        function toggleAllCheckboxes(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            const masterCheckbox = document.querySelector('thead .vocab-checkbox');
            if (masterCheckbox) masterCheckbox.checked = true;
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            const masterCheckbox = document.querySelector('thead .vocab-checkbox');
            if (masterCheckbox) masterCheckbox.checked = false;
        }

        function confirmSelection() {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            const selectedIndices = [];
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedIndices.push(parseInt(cb.dataset.index));
                }
            });
            
            if (selectedIndices.length === 0) {
                alert('âš ï¸ è«‹è‡³å°‘å‹¾é¸ä¸€å€‹å–®å­—ï¼');
                return;
            }
            
            const originalCount = vocabularyList.length;
            const removedCount = originalCount - selectedIndices.length;
            
            vocabularyList = vocabularyList.filter((item, index) => selectedIndices.includes(index));
            
            document.getElementById('vocabCount').textContent = `(${vocabularyList.length} å€‹è©å½™)`;
            
            renderVocabTable(false);
            
            document.getElementById('selectAllBtn').style.display = 'none';
            document.getElementById('deselectAllBtn').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'none';
            
            if (removedCount > 0) {
                alert(`âœ… å·²ä¿ç•™ ${vocabularyList.length} å€‹å–®å­—ï¼\nå·²ç§»é™¤ ${removedCount} å€‹æœªå‹¾é¸çš„å–®å­—ã€‚`);
            } else {
                alert(`âœ… å·²ç¢ºèªä¿ç•™å…¨éƒ¨ ${vocabularyList.length} å€‹å–®å­—ï¼`);
            }
        }

        function downloadCSV() {
            if (vocabularyList.length === 0) {
                alert('ç›®å‰æ²’æœ‰å–®å­—è¡¨');
                return;
            }

            let csv = `${detectedSourceLanguage},${targetLanguage},å‚™è¨»\n`;
            vocabularyList.forEach(item => {
                csv += `"${item.original}","${item.translation}","${item.note}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å–®å­—è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            alert('âœ… CSV æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
        }

        function downloadMarkdown() {
            if (vocabularyList.length === 0) {
                alert('ç›®å‰æ²’æœ‰å–®å­—è¡¨');
                return;
            }

            let md = `# å–®å­—è¡¨\n\n| ${detectedSourceLanguage} | ${targetLanguage} | å‚™è¨» |\n|------|------|------|\n`;
            vocabularyList.forEach(item => {
                md += `| ${item.original} | ${item.translation} | ${item.note} |\n`;
            });

            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å–®å­—è¡¨_${new Date().toISOString().slice(0,10)}.md`;
            link.click();
            alert('âœ… Markdown æª”æ¡ˆå·²ä¸‹è¼‰ï¼');
        }
    </script>
</body>
</html>
