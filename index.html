<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÁøªË≠ØÁ≥ªÁµ± - Vercel Áâà</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #e0e7ff;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #d1d5db;
            --btn-primary: #2563eb;
            --btn-primary-hover: #1d4ed8;
            --output-bg: #f9fafb;
            --purple-border: #c4b5fd;
            --purple-bg: #faf5ff;
        }
        
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --btn-primary: #3b82f6;
            --btn-primary-hover: #2563eb;
            --output-bg: #0f172a;
            --purple-border: #7c3aed;
            --purple-bg: #1e1b4b;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
            background: linear-gradient(to bottom right, var(--bg-primary), var(--bg-secondary)); 
            min-height: 100vh; 
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        h1 { font-size: 32px; color: var(--text-primary); }
        
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .theme-toggle { 
            background: var(--bg-card); 
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }
        .theme-toggle:hover { transform: scale(1.1); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--btn-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--btn-primary-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3); }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover { background: #15803d; transform: translateY(-2px); }
        .btn-indigo { background: #6366f1; color: white; }
        .btn-indigo:hover { background: #4f46e5; transform: translateY(-2px); }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            padding: 24px; 
            margin-bottom: 24px;
            transition: background 0.3s;
        }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        
        @media (max-width: 1200px) {
            .grid-3 { grid-template-columns: 1fr; }
            h1 { font-size: 24px; }
        }
        
        textarea { 
            width: 100%; 
            height: 250px; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            resize: vertical; 
            font-size: 14px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        textarea:focus { outline: none; border-color: var(--btn-primary); }
        
        .output { 
            width: 100%; 
            min-height: 250px; 
            padding: 12px; 
            background: var(--output-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
            font-size: 14px;
            line-height: 1.6;
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 16px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background: var(--bg-secondary); font-weight: 600; }
        tr:hover { background: var(--output-bg); }
        
        .checkbox-cell { width: 50px; text-align: center; }
        .vocab-checkbox { 
            width: 18px; 
            height: 18px; 
            cursor: pointer;
            accent-color: var(--btn-primary);
        }
        
        .settings-modal { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.5); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
            animation: fadeIn 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .settings-content { 
            background: var(--bg-card); 
            border-radius: 12px; 
            padding: 32px; 
            max-width: 500px; 
            width: 90%;
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            margin: 8px 0;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .input:focus { outline: none; border-color: var(--btn-primary); }
        
        .spinner { 
            border: 3px solid var(--border-color); 
            border-top: 3px solid var(--btn-primary); 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 100px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
        .purple-card { border: 2px solid var(--purple-border); }
        .purple-output { background: var(--purple-bg); }
        
        .error-message { 
            color: #ef4444; 
            padding: 12px; 
            background: #fee2e2; 
            border-radius: 8px; 
            margin-top: 12px;
        }
        
        [data-theme="dark"] .error-message {
            background: #7f1d1d;
            color: #fca5a5;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-success { background: #d1fae5; color: #065f46; }
        .status-loading { background: #dbeafe; color: #1e40af; }
        
        [data-theme="dark"] .status-success { background: #064e3b; color: #6ee7b7; }
        [data-theme="dark"] .status-loading { background: #1e3a8a; color: #93c5fd; }
        
        .selection-hint {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #1e40af;
        }
        
        [data-theme="dark"] .selection-hint {
            background: #1e3a8a;
            border-color: #3b82f6;
            color: #93c5fd;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUpAnim {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
        
        .vocab-settings-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 24px;
            border: none;
            animation: slideDown 0.3s ease-out;
        }
        
        .vocab-settings-panel h2,
        .vocab-settings-panel p,
        .vocab-settings-panel label {
            color: white;
        }
        
        .vocab-settings-panel select {
            background: white;
            color: #1f2937;
        }
        
        .vocab-settings-panel .btn-primary {
            background: white;
            color: #667eea;
        }
        
        .vocab-settings-panel .btn-primary:hover {
            background: #f3f4f6;
            color: #4f46e5;
        }
        
        .vocab-settings-panel button[title="ÈóúÈñâ"]:hover {
            opacity: 0.8;
            transform: scale(1.1);
        }
        
        [data-theme="dark"] .vocab-settings-panel {
            background: linear-gradient(135deg, #4c1d95 0%, #581c87 100%);
        }
        
        [data-theme="dark"] .vocab-settings-panel select {
            background: #1e293b;
            color: #f1f5f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê Êô∫ËÉΩÁøªË≠ØÁ≥ªÁµ±</h1>
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊèõÊ∑±Ëâ≤/Ê∑∫Ëâ≤Ê®°Âºè">üåì</button>
                <button class="btn btn-secondary" onclick="showSettings()">‚öôÔ∏è Ë®≠ÂÆö</button>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="translate()" id="translateBtn">ÈñãÂßãÁøªË≠Ø</button>
            <button class="btn btn-indigo" onclick="showVocabSettings()" id="vocabBtn">üìö Ë£Ω‰ΩúÂñÆÂ≠óË°®</button>
        </div>

        <div id="vocabSettingsPanel" class="card vocab-settings-panel" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0; font-size: 20px;">üìö ÂñÆÂ≠óË°®Ë®≠ÂÆö</h2>
                <button onclick="closeVocabSettings()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; padding: 4px 8px; line-height: 1;" title="ÈóúÈñâ">‚úï</button>
            </div>
            <p style="margin-bottom: 16px; opacity: 0.95;">ÈÅ∏ÊìáÁøªË≠ØÁõÆÊ®ôË™ûË®Ä</p>
            
            <div style="margin-bottom: 12px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">ÁøªË≠ØË™ûË®ÄÔºö</label>
                <select class="input" id="targetLang">
                    <option value="ÁπÅÈ´î‰∏≠ÊñáÔºàÂè∞ÁÅ£Ôºâ">ÁπÅÈ´î‰∏≠ÊñáÔºàÂè∞ÁÅ£Ôºâ</option>
                    <option value="Ëã±Êñá">Ëã±Êñá</option>
                    <option value="Êó•Êñá">Êó•Êñá</option>
                    <option value="ÈüìÊñá">ÈüìÊñá</option>
                    <option value="Ê≥ïÊñá">Ê≥ïÊñá</option>
                    <option value="Âæ∑Êñá">Âæ∑Êñá</option>
                    <option value="Ë•øÁè≠ÁâôÊñá">Ë•øÁè≠ÁâôÊñá</option>
                    <option value="Áæ©Â§ßÂà©Êñá">Áæ©Â§ßÂà©Êñá</option>
                    <option value="Ëë°ËêÑÁâôÊñá">Ëë°ËêÑÁâôÊñá</option>
                    <option value="‰øÑÊñá">‰øÑÊñá</option>
                    <option value="ÈòøÊãâ‰ºØÊñá">ÈòøÊãâ‰ºØÊñá</option>
                    <option value="Ê≥∞Êñá">Ê≥∞Êñá</option>
                    <option value="Ë∂äÂçóÊñá">Ë∂äÂçóÊñá</option>
                    <option value="Âç∞Â∞ºÊñá">Âç∞Â∞ºÊñá</option>
                </select>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="generateVocabWithSettings()">ÈñãÂßãË£Ω‰Ωú</button>
                <button class="btn btn-secondary" onclick="closeVocabSettings()">ÂèñÊ∂à</button>
            </div>
        </div>

        <div class="grid-3">
            <div class="card">
                <h2 style="margin-bottom: 12px; font-size: 18px;">ÂéüÊñá</h2>
                <textarea id="sourceText" placeholder="Ëº∏ÂÖ•‰ªª‰ΩïË™ûË®ÄÁöÑÊñáÂ≠ó..."></textarea>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 12px; font-size: 18px;">
                    ÂàùÊ≠•Ë≠ØÊñá 
                    <span style="font-size: 12px; color: var(--text-secondary);">(Sonnet 4)</span>
                    <span id="translateStatus1"></span>
                </h2>
                <div class="output" id="targetText">ÁøªË≠ØÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®Ê≠§...</div>
            </div>

            <div class="card purple-card">
                <h2 style="margin-bottom: 12px; font-size: 18px;">
                    ÊΩ§Á®øÁµêÊûú 
                    <span style="font-size: 12px; color: #7c3aed;">(Opus 4)</span>
                    <span id="translateStatus2"></span>
                </h2>
                <div class="output purple-output" id="polishedText">ÊΩ§Á®øÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®Ê≠§...</div>
            </div>
        </div>

        <div id="vocabSection" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                    <h2 style="font-size: 20px;">ÂñÆÂ≠óË°® <span id="vocabCount"></span></h2>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="selectAll()" id="selectAllBtn" style="display: none;">‚úì ÂÖ®ÈÅ∏</button>
                        <button class="btn btn-secondary" onclick="deselectAll()" id="deselectAllBtn" style="display: none;">‚úó ÂÖ®‰∏çÈÅ∏</button>
                        <button class="btn btn-indigo" onclick="confirmSelection()" id="confirmBtn" style="display: none;">Á¢∫Ë™ç‰øùÁïôÂãæÈÅ∏È†ÖÁõÆ</button>
                        <button class="btn btn-success" onclick="downloadCSV()">üìä ‰∏ãËºâ CSV</button>
                        <button class="btn btn-primary" onclick="downloadMarkdown()">üìù ‰∏ãËºâ Markdown</button>
                    </div>
                </div>
                <div id="vocabTable"></div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 24px; color: var(--text-secondary); font-size: 14px;">
            <p>‚ú® Vercel ÁâàÊú¨ ‚Ä¢ ‰ΩøÁî®ÊÇ®Ëá™Â∑±ÁöÑ API Key ‚Ä¢ ÊâÄÊúâË≥áÊñôÂÉÖÂú®Êú¨Ê©üËôïÁêÜ</p>
        </div>
    </div>

    <div id="settingsModal" class="settings-modal" style="display: none;">
        <div class="settings-content">
            <h2 style="margin-bottom: 16px; font-size: 24px;">üîë API Key Ë®≠ÂÆö</h2>
            <p style="margin-bottom: 12px; color: var(--text-secondary);">Ë´ãËº∏ÂÖ•ÊÇ®ÁöÑ Anthropic API Key</p>
            <p style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary);">
                ÂèñÂæóÊñπÂºèÔºö<br>
                1. ÂâçÂæÄ <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color: var(--btn-primary);">Anthropic Console</a><br>
                2. Âª∫Á´ãÊñ∞ÁöÑ API Key<br>
                3. Ë§áË£ΩÈáëÈë∞ÔºàÊ†ºÂºèÔºösk-ant-xxxxxÔºâ
            </p>
            <input type="password" class="input" id="apiKeyInput" placeholder="sk-ant-xxxxx...">
            <div style="display: flex; gap: 8px; margin-top: 16px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="saveApiKey()">ÂÑ≤Â≠ò‰∏¶ÈñãÂßã‰ΩøÁî®</button>
                <button class="btn btn-secondary" onclick="closeSettings()">ÂèñÊ∂à</button>
            </div>
            <p style="margin-top: 16px; font-size: 12px; color: var(--text-secondary);">
                üí° API Key ÂÉÖÂÑ≤Â≠òÂú®ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏≠ÔºåÈÄèÈÅéÊÇ®ÁöÑ Vercel ‰º∫ÊúçÂô®ÂÇ≥ÈÅû
            </p>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('anthropic_api_key') || '';
        let vocabularyList = [];
        let targetLanguage = 'ÁπÅÈ´î‰∏≠ÊñáÔºàÂè∞ÁÅ£Ôºâ';
        let detectedSourceLanguage = 'ÂéüÊñá';

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        if (!apiKey) {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function showSettings() {
            document.getElementById('apiKeyInput').value = apiKey;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            if (apiKey) {
                document.getElementById('settingsModal').style.display = 'none';
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input && input.startsWith('sk-ant-')) {
                apiKey = input;
                localStorage.setItem('anthropic_api_key', apiKey);
                document.getElementById('settingsModal').style.display = 'none';
                alert('‚úÖ API Key Â∑≤ÂÑ≤Â≠òÔºÅ');
            } else {
                alert('‚ö†Ô∏è Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑ API KeyÔºàÊ†ºÂºèÔºösk-ant-xxxxxÔºâ');
            }
        }

        function showVocabSettings() {
            if (!apiKey) {
                alert('Ë´ãÂÖàË®≠ÂÆö API Key');
                showSettings();
                return;
            }

            const sourceText = document.getElementById('sourceText').value.trim();
            if (!sourceText) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÊñáÂ≠ó');
                return;
            }

            document.getElementById('vocabSettingsPanel').style.display = 'block';
            document.getElementById('vocabSettingsPanel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function closeVocabSettings() {
            const panel = document.getElementById('vocabSettingsPanel');
            panel.style.animation = 'slideUpAnim 0.3s ease-out';
            setTimeout(() => {
                panel.style.display = 'none';
                panel.style.animation = '';
            }, 300);
        }

        async function callClaude(prompt, model = 'claude-sonnet-4-20250514', retries = 2) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch('/api/claude', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prompt: prompt,
                            model: model,
                            apiKey: apiKey
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error?.message || `API ÈåØË™§: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.content[0].text;
                } catch (error) {
                    console.error('API ÂëºÂè´ÈåØË™§:', error);
                    if (i === retries) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        async function translate() {
            if (!apiKey) {
                alert('Ë´ãÂÖàË®≠ÂÆö API Key');
                showSettings();
                return;
            }

            const sourceText = document.getElementById('sourceText').value.trim();
            if (!sourceText) {
                alert('Ë´ãÂÖàËº∏ÂÖ•ÊñáÂ≠ó');
                return;
            }

            document.getElementById('translateBtn').disabled = true;
            document.getElementById('vocabBtn').disabled = true;
            document.getElementById('targetText').innerHTML = '<div class="spinner"></div>';
            document.getElementById('polishedText').innerHTML = '<div class="spinner"></div>';
            document.getElementById('translateStatus1').innerHTML = '<span class="status-indicator status-loading">ÁøªË≠Ø‰∏≠...</span>';
            document.getElementById('translateStatus2').innerHTML = '<span class="status-indicator status-loading">Á≠âÂæÖ‰∏≠...</span>';

            try {
                const translationPrompt = `‰Ω†ÊòØÂ∞àÊ•≠ÁöÑÁøªË≠ØÂ∞àÂÆ∂„ÄÇË´ãÂ∞á‰ª•‰∏ãÊñáÂ≠óÁøªË≠ØÊàêÁπÅÈ´î‰∏≠ÊñáÔºàÂè∞ÁÅ£Áî®Ë™ûÔºâ„ÄÇ

Ë¶ÅÊ±ÇÔºö
- ‰øùÊåÅÂéüÊñáÁöÑË™ûÊ∞£ÂíåÈ¢®Ê†º
- ‰ΩøÁî®Âè∞ÁÅ£ÊÖ£Áî®ÁöÑË©ûÂΩôÂíåË°®ÈÅîÊñπÂºè
- Á¢∫‰øùÁøªË≠ØÊµÅÊö¢Ëá™ÁÑ∂
- Âè™Ëº∏Âá∫ÁøªË≠ØÁµêÊûúÔºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïË™™ÊòéÊàñË®ªËß£

ÂéüÊñáÔºö
${sourceText}`;

                const translation = await callClaude(translationPrompt);
                document.getElementById('targetText').textContent = translation;
                document.getElementById('translateStatus1').innerHTML = '<span class="status-indicator status-success">ÂÆåÊàê</span>';
                document.getElementById('translateStatus2').innerHTML = '<span class="status-indicator status-loading">ÊΩ§Á®ø‰∏≠...</span>';

                const polishPrompt = `‰Ω†ÊòØË≥áÊ∑±ÁöÑÁøªË≠ØÂØ©Ê†°Â∞àÂÆ∂„ÄÇË´ãÂØ©Ê†∏‰∏¶ÂÑ™Âåñ‰ª•‰∏ãÁøªË≠Ø„ÄÇ

‰ªªÂãôÔºö
1. Ê™¢Êü•ÁøªË≠ØÊ∫ñÁ¢∫ÊÄßÔºåÁ¢∫‰øùÂø†ÊñºÂéüÊñá
2. ÊîπÂñÑË™ûÂè•ÊµÅÊö¢Â∫¶ÂíåËá™ÁÑ∂Â∫¶
3. ÂÑ™ÂåñÁî®Ë©ûÔºå‰ΩøÂÖ∂Êõ¥Á¨¶ÂêàÂè∞ÁÅ£Áî®Ë™ûÁøíÊÖ£
4. Á¢∫‰øùÊï¥È´îÈñ±ËÆÄÈ´îÈ©óËâØÂ•Ω
5. Âè™Ëº∏Âá∫ÊúÄÁµÇÁöÑÊΩ§Á®øÁµêÊûúÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπ

ÂéüÊñáÔºö
${sourceText}

ÂàùÊ≠•Ë≠ØÊñáÔºö
${translation}

Ë´ãÊèê‰æõÊΩ§Á®øÂæåÁöÑÊúÄÁµÇÁâàÊú¨Ôºö`;

                const polished = await callClaude(polishPrompt, 'claude-opus-4-20250514');
                document.getElementById('polishedText').textContent = polished;
                document.getElementById('translateStatus2').innerHTML = '<span class="status-indicator status-success">ÂÆåÊàê</span>';

                alert('‚úÖ ÁøªË≠ØÂÆåÊàêÔºÅ');
            } catch (error) {
                console.error('ÁøªË≠ØÈåØË™§:', error);
                const errorMsg = `ÁøªË≠ØÂ§±ÊïóÔºö${error.message}`;
                document.getElementById('targetText').innerHTML = `<div class="error-message">${errorMsg}</div>`;
                document.getElementById('polishedText').innerHTML = `<div class="error-message">${errorMsg}</div>`;
                document.getElementById('translateStatus1').textContent = '';
                document.getElementById('translateStatus2').textContent = '';
                alert('‚ùå ' + errorMsg);
            } finally {
                document.getElementById('translateBtn').disabled = false;
                document.getElementById('vocabBtn').disabled = false;
            }
        }

        async function generateVocabWithSettings() {
            targetLanguage = document.getElementById('targetLang').value;
            
            const panel = document.getElementById('vocabSettingsPanel');
            panel.style.animation = 'slideUpAnim 0.3s ease-out';
            setTimeout(() => {
                panel.style.display = 'none';
                panel.style.animation = '';
            }, 300);
            
            await generateVocab();
        }

        async function generateVocab() {
            const sourceText = document.getElementById('sourceText').value.trim();

            document.getElementById('translateBtn').disabled = true;
            document.getElementById('vocabBtn').disabled = true;
            document.getElementById('vocabSection').style.display = 'block';
            document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div>';

            try {
                const detectPrompt = `Ë´ãÂÅµÊ∏¨‰ª•‰∏ãÊñáÂ≠óÁöÑË™ûË®ÄÔºåÂè™ÂõûÁ≠îË™ûË®ÄÂêçÁ®±Ôºà‰æãÂ¶ÇÔºöËã±Êñá„ÄÅÊó•Êñá„ÄÅÁπÅÈ´î‰∏≠Êñá„ÄÅÈüìÊñá„ÄÅÊ≥ïÊñáÁ≠âÔºâÔºå‰∏çË¶ÅÂÖ∂‰ªñÂÖßÂÆπÔºö

${sourceText.substring(0, 200)}`;
                
                detectedSourceLanguage = (await callClaude(detectPrompt)).trim();
                
                const textLength = sourceText.length;
                let allVocabulary = [];
                
                if (textLength <= 500) {
                    document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">Ê≠£Âú®ÊèêÂèñË©ûÂΩô...</p>';
                    
                    allVocabulary = await extractVocabFromSegment(sourceText, 20);
                } else {
                    const segments = splitTextIntoSegments(sourceText, 500);
                    document.getElementById('vocabTable').innerHTML = `<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">ÊñáÁ´†ËºÉÈï∑ÔºåÊ≠£Âú®ÂàÜÊÆµËôïÁêÜ... (ÂÖ± ${segments.length} ÊÆµ)</p>`;
                    
                    for (let i = 0; i < segments.length; i++) {
                        document.getElementById('vocabTable').innerHTML = `<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">ËôïÁêÜÁ¨¨ ${i + 1}/${segments.length} ÊÆµ...</p>`;
                        
                        const segmentVocab = await extractVocabFromSegment(segments[i], 15);
                        allVocabulary = allVocabulary.concat(segmentVocab);
                    }
                    
                    document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">Ê≠£Âú®Âêà‰Ωµ‰∏¶ÂéªÈáç...</p>';
                    allVocabulary = removeDuplicates(allVocabulary);
                    
                    if (allVocabulary.length > 50) {
                        document.getElementById('vocabTable').innerHTML = '<div class="spinner"></div><p style="text-align: center; margin-top: 12px; color: var(--text-secondary);">Ê≠£Âú®ÁØ©ÈÅ∏ÊúÄÈáçË¶ÅÁöÑË©ûÂΩô...</p>';
                        allVocabulary = await rankAndSelectVocabulary(allVocabulary, sourceText);
                    }
                }
                
                vocabularyList = allVocabulary;
                document.getElementById('vocabCount').textContent = `(${vocabularyList.length} ÂÄãË©ûÂΩô)`;
                
                renderVocabTable(true);
                
                document.getElementById('selectAllBtn').style.display = 'inline-block';
                document.getElementById('deselectAllBtn').style.display = 'inline-block';
                document.getElementById('confirmBtn').style.display = 'inline-block';

                setTimeout(() => {
                    document.getElementById('vocabSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

                alert('‚úÖ ÂñÆÂ≠óË°®Áî¢ÁîüÂÆåÊàêÔºÅË´ãÂãæÈÅ∏ÊÇ®ÊÉ≥‰øùÁïôÁöÑÂñÆÂ≠ó„ÄÇ');
            } catch (error) {
                console.error('ÂñÆÂ≠óË°®Áî¢ÁîüÈåØË™§:', error);
                const errorMsg = `Áî¢ÁîüÂ§±ÊïóÔºö${error.message}`;
                document.getElementById('vocabTable').innerHTML = `<div class="error-message">${errorMsg}</div>`;
                alert('‚ùå ' + errorMsg);
            } finally {
                document.getElementById('translateBtn').disabled = false;
                document.getElementById('vocabBtn').disabled = false;
            }
        }

        function splitTextIntoSegments(text, maxLength) {
            const segments = [];
            let currentPos = 0;
            
            while (currentPos < text.length) {
                let endPos = currentPos + maxLength;
                
                if (endPos < text.length) {
                    const searchText = text.substring(currentPos, endPos + 100);
                    const sentenceEnds = [
                        searchText.indexOf('„ÄÇ'),
                        searchText.indexOf('Ôºü'),
                        searchText.indexOf('ÔºÅ'),
                        searchText.indexOf('. '),
                        searchText.indexOf('? '),
                        searchText.indexOf('! '),
                        searchText.indexOf('\n\n')
                    ].filter(pos => pos > maxLength * 0.7 && pos !== -1);
                    
                    if (sentenceEnds.length > 0) {
                        endPos = currentPos + Math.min(...sentenceEnds) + 1;
                    }
                }
                
                segments.push(text.substring(currentPos, endPos).trim());
                currentPos = endPos;
            }
            
            return segments;
        }

        async function extractVocabFromSegment(text, count) {
            const vocabPrompt = `‰Ω†ÊòØÂ∞àÊ•≠ÁöÑË™ûË®ÄÊïôÂ≠∏Â∞àÂÆ∂„ÄÇË´ãÂæû‰ª•‰∏ãÊñáÂ≠óÁâáÊÆµ‰∏≠ÊèêÂèñ ${count} ÂÄãÊúÄÈáçË¶ÅÁöÑÂ≠∏ÁøíË©ûÂΩô„ÄÇ

„ÄêÊèêÂèñÊ®ôÊ∫ñ„Äë
‚úÖ ÂøÖÈ†àÊèêÂèñÔºö
- ÈáçË¶ÅÁöÑÂ∞àÊ•≠Ë°ìË™ûÂíåÊ†∏ÂøÉÊ¶ÇÂøµË©ûÂΩô
- ÈóúÈçµÂãïË©û„ÄÅÂêçË©û„ÄÅÂΩ¢ÂÆπË©û
- Âõ∫ÊúâÂêçË©ûÂíåÂ∞àÊúâÂêçË©û
- ÊÖ£Áî®Ë™ûÂíåÈáçË¶ÅË°®ÈÅî

‚ùå ‰∏çË¶ÅÊèêÂèñÔºö
- Âü∫Á§éÂâØË©ûÔºàÂ¶ÇÔºöÂæà„ÄÅÈùûÂ∏∏Ôºâ
- ÈÅéÊñºÁ∞°ÂñÆÁöÑÊó•Â∏∏Áî®Ë™û
- ÈÄ£Êé•Ë©ûÂíåÂä©Ë©û

ÊñáÂ≠óÁâáÊÆµÔºö
${text}

„ÄêÁøªË≠ØË¶ÅÊ±Ç„Äë
Â∞çÊØèÂÄãË©ûÂΩôÁøªË≠ØÊàê${targetLanguage}ÊôÇÔºö
- Â¶ÇÊûúÊúâÂ§öÁ®ÆÂêàÈÅ©ÁöÑÁøªË≠ØÊñπÂºèÔºà‰æãÂ¶ÇÔºö‰∏çÂêåË™ûÂ¢É„ÄÅÊ≠£Âºè/ÈùûÊ≠£Âºè„ÄÅÊñáË®Ä/ÁôΩË©±Á≠âÔºâÔºåË´ãÊèê‰æõ 2-3 ÂÄãÁøªË≠ØÈÅ∏È†Ö
- Â¶ÇÊûúÂè™Êúâ‰∏ÄÁ®ÆÊúÄ‰Ω≥ÁøªË≠ØÔºåÂ∞±Âè™Êèê‰æõ‰∏ÄÁ®Æ
- Â¶ÇÊûú‰∏çÈÅ©ÂêàÁøªË≠ØÔºà‰æãÂ¶ÇÔºöÂ∞àÊúâÂêçË©û„ÄÅ‰∫∫Âêç„ÄÅÂú∞Âêç„ÄÅÂìÅÁâåÂêçÁ≠âÔºâÔºåË´ãÂú® translation Â°´ÂÖ•ÂéüÊñáÔºå‰∏¶Âú®ÂÇôË®ªË™™Êòé„Äå‰∏çÈúÄÁøªË≠Ø„ÄçÁöÑÂéüÂõ†

Ë´ãÂö¥Ê†ºÊåâÁÖß‰ª•‰∏ã JSON Ê†ºÂºèÂõûÊáâÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰Ωï markdown Ê®ôË®òÔºö
{
  "vocabulary": [
    {
      "original": "ÂéüÊñáË©ûÂΩô",
      "translation": "ÁøªË≠Ø1 / ÁøªË≠Ø2 / ÁøªË≠Ø3",
      "note": "[Ë©ûÊÄß] Ë™™ÊòéÂ∑ÆÁï∞Êàñ‰∏çÁøªË≠ØÂéüÂõ†"
    }
  ]
}`;

            const result = await callClaude(vocabPrompt, 'claude-opus-4-20250514');
            const cleanResult = result.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            return JSON.parse(cleanResult).vocabulary;
        }

        function removeDuplicates(vocabulary) {
            const seen = new Map();
            
            vocabulary.forEach(item => {
                const key = item.original.toLowerCase().trim();
                if (!seen.has(key)) {
                    seen.set(key, item);
                } else {
                    const existing = seen.get(key);
                    const existingTranslations = existing.translation.split(' / ');
                    const newTranslations = item.translation.split(' / ');
                    
                    newTranslations.forEach(trans => {
                        if (!existingTranslations.includes(trans)) {
                            existingTranslations.push(trans);
                        }
                    });
                    
                    existing.translation = existingTranslations.join(' / ');
                }
            });
            
            return Array.from(seen.values());
        }

        async function rankAndSelectVocabulary(vocabulary, fullText) {
            const rankPrompt = `‰Ω†ÊòØÂ∞àÊ•≠ÁöÑË™ûË®ÄÊïôÂ≠∏Â∞àÂÆ∂„ÄÇ‰ª•‰∏ãÊòØÂæû‰∏ÄÁØáÊñáÁ´†‰∏≠ÊèêÂèñÁöÑË©ûÂΩôÂàóË°®Ôºå‰ΩÜÊï∏ÈáèÈÅéÂ§ö„ÄÇË´ãÂπ´ÊàëÁØ©ÈÅ∏Âá∫ÊúÄÈáçË¶ÅÁöÑ 50 ÂÄãË©ûÂΩô„ÄÇ

ÁØ©ÈÅ∏Ê®ôÊ∫ñÔºö
1. ËàáÊñáÁ´†‰∏ªÈ°åÊúÄÁõ∏ÈóúÁöÑÊ†∏ÂøÉË©ûÂΩô
2. Â≠∏ÁøíÂÉπÂÄºÈ´òÁöÑË©ûÂΩô
3. Âá∫ÁèæÈ†ªÁéáËºÉÈ´òÊàñÂú®ÈóúÈçµ‰ΩçÁΩÆÁöÑË©ûÂΩô
4. Â∞àÊ•≠Ë°ìË™ûÂÑ™ÂÖàÊñº‰∏ÄËà¨Ë©ûÂΩô

ÂéüÊñáÁ´†‰∏ªÈ°åÊ¶ÇË¶ÅÔºö
${fullText.substring(0, 500)}...

Ë©ûÂΩôÂàóË°®ÔºàJSON Ê†ºÂºèÔºâÔºö
${JSON.stringify(vocabulary, null, 2)}

Ë´ãÂæû‰ª•‰∏äË©ûÂΩô‰∏≠ÈÅ∏Âá∫ÊúÄÈáçË¶ÅÁöÑ 50 ÂÄãÔºå‰øùÊåÅÂéüÊúâÁöÑ JSON Ê†ºÂºèÂíåÂÖßÂÆπÔºåÂè™ÈúÄË¶ÅËº∏Âá∫ÁØ©ÈÅ∏ÂæåÁöÑÁµêÊûúÔºö
{
  "vocabulary": [...]
}`;

            const result = await callClaude(rankPrompt, 'claude-opus-4-20250514');
            const cleanResult = result.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            return JSON.parse(cleanResult).vocabulary;
        }

        function renderVocabTable(withCheckbox = false) {
            let html = '';
            
            if (withCheckbox) {
                html += `<div class="selection-hint">
                    üí° <strong>ÊèêÁ§∫Ôºö</strong>Ë´ãÂãæÈÅ∏ÊÇ®ÊÉ≥Ë¶Å‰øùÁïôÁöÑÂñÆÂ≠óÔºåÂèñÊ∂àÂãæÈÅ∏‰∏çÈúÄË¶ÅÁöÑÂñÆÂ≠óÔºåÁÑ∂ÂæåÈªûÈÅ∏„ÄåÁ¢∫Ë™ç‰øùÁïôÂãæÈÅ∏È†ÖÁõÆ„Äç
                </div>`;
            }
            
            html += `<div style="overflow-x: auto;"><table>
                <thead>
                    <tr>`;
            
            if (withCheckbox) {
                html += `<th class="checkbox-cell">
                    <input type="checkbox" class="vocab-checkbox" onchange="toggleAllCheckboxes(this)" checked title="ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏">
                </th>`;
            }
            
            html += `<th>${detectedSourceLanguage}</th>
                    <th>${targetLanguage}</th>
                    <th>ÂÇôË®ª</th>
                </tr>
            </thead>
            <tbody>`;
            
            vocabularyList.forEach((item, index) => {
                html += `<tr>`;
                
                if (withCheckbox) {
                    html += `<td class="checkbox-cell">
                        <input type="checkbox" class="vocab-checkbox vocab-item-checkbox" data-index="${index}" checked>
                    </td>`;
                }
                
                html += `<td>${item.original}</td>
                    <td>${item.translation}</td>
                    <td>${item.note}</td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('vocabTable').innerHTML = html;
        }

        function toggleAllCheckboxes(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            checkboxes.forEach(cb => cb.checked = masterCheckbox.checked);
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            const masterCheckbox = document.querySelector('thead .vocab-checkbox');
            if (masterCheckbox) masterCheckbox.checked = true;
        }

        function deselectAll() {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            const masterCheckbox = document.querySelector('thead .vocab-checkbox');
            if (masterCheckbox) masterCheckbox.checked = false;
        }

        function confirmSelection() {
            const checkboxes = document.querySelectorAll('.vocab-item-checkbox');
            const selectedIndices = [];
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedIndices.push(parseInt(cb.dataset.index));
                }
            });
            
            if (selectedIndices.length === 0) {
                alert('‚ö†Ô∏è Ë´ãËá≥Â∞ëÂãæÈÅ∏‰∏ÄÂÄãÂñÆÂ≠óÔºÅ');
                return;
            }
            
            const originalCount = vocabularyList.length;
            const removedCount = originalCount - selectedIndices.length;
            
            vocabularyList = vocabularyList.filter((item, index) => selectedIndices.includes(index));
            
            document.getElementById('vocabCount').textContent = `(${vocabularyList.length} ÂÄãË©ûÂΩô)`;
            
            renderVocabTable(false);
            
            document.getElementById('selectAllBtn').style.display = 'none';
            document.getElementById('deselectAllBtn').style.display = 'none';
            document.getElementById('confirmBtn').style.display = 'none';
            
            if (removedCount > 0) {
                alert(`‚úÖ Â∑≤‰øùÁïô ${vocabularyList.length} ÂÄãÂñÆÂ≠óÔºÅ\nÂ∑≤ÁßªÈô§ ${removedCount} ÂÄãÊú™ÂãæÈÅ∏ÁöÑÂñÆÂ≠ó„ÄÇ`);
            } else {
                alert(`‚úÖ Â∑≤Á¢∫Ë™ç‰øùÁïôÂÖ®ÈÉ® ${vocabularyList.length} ÂÄãÂñÆÂ≠óÔºÅ`);
            }
        }

        function downloadCSV() {
            if (vocabularyList.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâÂñÆÂ≠óË°®');
                return;
            }

            let csv = `${detectedSourceLanguage},${targetLanguage},ÂÇôË®ª\n`;
            vocabularyList.forEach(item => {
                csv += `"${item.original}","${item.translation}","${item.note}"\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ÂñÆÂ≠óË°®_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            alert('‚úÖ CSV Ê™îÊ°àÂ∑≤‰∏ãËºâÔºÅ');
        }

        function downloadMarkdown() {
            if (vocabularyList.length === 0) {
                alert('ÁõÆÂâçÊ≤íÊúâÂñÆÂ≠óË°®');
                return;
            }

            let md = `# ÂñÆÂ≠óË°®\n\n| ${detectedSourceLanguage} | ${targetLanguage} | ÂÇôË®ª |\n|------|------|------|\n`;
            vocabularyList.forEach(item => {
                md += `| ${item.original} | ${item.translation} | ${item.note} |\n`;
            });

            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ÂñÆÂ≠óË°®_${new Date().toISOString().slice(0,10)}.md`;
            link.click();
            alert('‚úÖ Markdown Ê™îÊ°àÂ∑≤‰∏ãËºâÔºÅ');
        }
    </script>
</body>
</html>
